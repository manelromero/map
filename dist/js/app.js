var Location=function(e,n,i){this.name=ko.observable(e.name),this.address=ko.observable(e.address),this.show=ko.observable(e.show),this.position=ko.observable(e.position),this.marker=n,this.infoWindow=i},ViewModel=function(){function e(){document.getElementsByClassName("map")[0].style.height=window.innerHeight-60+"px"}var n=this,i=document.getElementsByClassName("filter-field")[0],o=document.getElementsByClassName("modal")[0],t=[];this.filterText=ko.observable(),this.allLocations=ko.observableArray([]),this.flickrPictures=ko.observableArray([]),this.wikiLinks=ko.observableArray([]),this.map=new google.maps.Map(document.getElementsByClassName("map")[0]),localStorage.mapLocations=JSON.stringify(locations),t=JSON.parse(localStorage.mapLocations),window.onresize=function(){e()},window.onclick=function(e){e.target==modal&&(o.style.display="none")},this.drawMap=function(){e(),this.map||(document.getElementsByClassName("map")[0].innerHTML="Sorry, map could not be loaded"),t.forEach(function(e){var i=new google.maps.Marker({position:e.position,map:n.map,title:e.name}),o='<div class="map-name">'+e.name+'</div><div class="map-address">'+e.address+'</div><div><a class="info-link">+info</a></div>',t=new google.maps.InfoWindow({content:o});i.addListener("click",function(){var e=t.anchor;if("undefined"==typeof e||null===e){t.open(n.map,i);var o=document.getElementsByClassName("info-link");o[o.length-1].addEventListener("click",function(){n.extraInfo(i)}),n.bounce(i)}else t.close()}),n.allLocations.push(new Location(e,i,t))})};var a=new google.maps.LatLng(41.365,2.123),s=new google.maps.LatLng(41.414,2.221),r=new google.maps.LatLngBounds(a,s);this.map.fitBounds(r),i.addEventListener("input",function(){n.filterText(this.value.toLowerCase())}),this.extraInfo=function(e){document.getElementsByClassName("flickr-pictures")[0].innerHTML="",document.getElementsByClassName("wiki-content")[0].innerHTML="",o.style.display="block",document.getElementsByClassName("close")[0].addEventListener("click",function(){o.style.display="none"});var i,t="https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=dc610307d5d7e99c3a682062435787d5";$.getJSON(t,{text:e.title,per_page:5,format:"json",nojsoncallback:1}).done(function(e){$.each(e.photos.photo,function(e,o){i="http://farm"+o.farm+".static.flickr.com/"+o.server+"/"+o.id+"_"+o.secret+".jpg",n.flickrPictures.push({pictureUrl:i})})}).fail(function(e){$("#flickr-images").append("<div>Sorry, Flickr images could not be loaded</div>")}),n.wikiLinks([]),$.ajax({url:"https://en.wikipedia.org/w/api.php?action=opensearch&search="+e.title,dataType:"jsonp",headers:{"Api-User-Agent":"Example/1.0"},success:function(e){var i=e[1];if(i.length>0)for(var o=0;o<i.length;o++){var t=i[o],a="http://en.wikipedia.org/wiki/"+t;n.wikiLinks.push({linkName:t,wikiLink:a})}else document.getElementsByClassName("wiki-content")[0].innerHTML="Sorry, no links from Wikipedia for this location"}}).fail(function(e){$("#wiki-content").append("Sorry, links from Wikipedia could not be loaded")})},this.toggleInfo=function(e){google.maps.event.trigger(e.marker,"click")},this.bounce=function(e){var n;n=e.hasOwnProperty("marker")?e.marker:e,n.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){n.setAnimation(null)},750)},this.filterLocations=ko.computed(function(){var e=n.filterText()||"";n.allLocations().forEach(function(i){var o=i.name().toLowerCase();-1==o.indexOf(e)?(i.show(!1),i.marker.setMap(null)):(i.show(!0),i.marker.setMap(n.map))})}),this.drawMap()};ko.applyBindings(new ViewModel);