"use strict";function startModel(){vm=new ViewModel,ko.applyBindings(vm)}function googleMapsError(){document.getElementsByClassName("map")[0].innerHTML='<div class="google-error">Sorry, Google Map could not be loaded</div>'}var LOC_SW=[41.365,2.123],LOC_NE=[41.414,2.221],vm,Location=function(o,e,i){this.id=o.id,this.name=ko.observable(o.name),this.address=ko.observable(o.address),this.show=ko.observable(!0),this.icon=ko.observable(o.icon),this.position=ko.observable(o.position),this.marker=e,this.infoWindow=i};Location.prototype.bounce=function(){var o;o=this.hasOwnProperty("marker")?this.marker:this,o.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){o.setAnimation(null)},750)},Location.prototype.extraInfo=function(){var o=document.getElementsByClassName("modal")[0];window.onclick=function(e){e.target==modal&&(o.style.display="none")},document.getElementsByClassName("flickr-pictures")[0].innerHTML="",document.getElementsByClassName("wiki-content")[0].innerHTML="",o.style.display="block",document.getElementsByClassName("close")[0].addEventListener("click",function(){o.style.display="none"});var e,i="https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=dc610307d5d7e99c3a682062435787d5",n=setTimeout(function(){console.log("jander"),vm.flickrError("Sorry, Flickr images could not be loaded")},8e3);$.getJSON(i,{text:this.name,per_page:5,format:"json",nojsoncallback:1}).done(function(o){o.photos.photo.length>0?$.each(o.photos.photo,function(o,i){e="http://farm"+i.farm+".static.flickr.com/"+i.server+"/"+i.id+"_"+i.secret+".jpg",vm.flickrPictures.push({pictureUrl:e})}):vm.flickrError("Sorry, Flickr images could not be loaded"),clearTimeout(n)}).fail(function(o){vm.flickrError("Sorry, Flickr images could not be loaded")}),this.infoWindow.close(),vm.flickrError(""),vm.wikiError("");var a=setTimeout(function(){vm.wikiError("Sorry, Wikipedia links could not be loaded")},8e3);$.ajax({url:"https://en.wikipedia.org/w/api.php?action=opensearch&search="+this.name(),dataType:"jsonp",headers:{"Api-User-Agent":"Example/1.0"}}).done(function(o){var e=o[1],i=e.length;if(i>0)for(var n=0;i>n;n++){var t=e[n],r="http://en.wikipedia.org/wiki/"+t;vm.wikiLinks.push({linkName:t,wikiLink:r})}else vm.wikiError("Sorry, no links from Wikipedia for this location");clearTimeout(a)}).fail(function(o){vm.wikiError("Sorry, Wikipedia links could not be loaded")})};var ViewModel=function(){function o(){document.getElementsByClassName("map")[0].style.height=window.innerHeight-60+"px"}var e=this,i=document.getElementsByClassName("filter-field")[0],n=[];e.flickrPictures=ko.observableArray([]),e.wikiLinks=ko.observableArray([]),e.flickrError=ko.observable(),e.wikiError=ko.observable(),e.filterText=ko.observable(),e.allLocations=ko.observableArray([]),e.map=new google.maps.Map(document.getElementsByClassName("map")[0]),localStorage.mapLocations=JSON.stringify(locations),n=JSON.parse(localStorage.mapLocations),window.onresize=function(){o()},e.drawMap=function(){o();var i=new google.maps.LatLng(LOC_SW[0],LOC_SW[1]),a=new google.maps.LatLng(LOC_NE[0],LOC_NE[1]),t=new google.maps.LatLngBounds(i,a),r=0;e.map.fitBounds(t),n.forEach(function(o){o.id=r;var i=new google.maps.Marker({position:o.position,map:e.map,icon:o.icon,title:o.name}),n='<div class="map-name">'+o.name+'</div><div class="map-address">'+o.address+'</div><div><a class="info-link">+info</a></div>',a=new google.maps.InfoWindow({content:n});e.allLocations.push(new Location(o,i,a)),r++,i.addListener("click",function(){for(var n=0;n<e.allLocations().length;n++)e.allLocations()[n].infoWindow.close();a.open(e.map,i);var t=document.getElementsByClassName("info-link")[0],r=function(){e.allLocations()[o.id].extraInfo(),t.removeEventListener("click",r,!1)};t.addEventListener("click",r,!1),e.allLocations()[o.id].bounce()})})},i.addEventListener("input",function(){e.filterText(e.value.toLowerCase())}),e.toggleInfo=function(o){google.maps.event.trigger(o.marker,"click")},e.filterLocations=ko.computed(function(){var o=e.filterText()||"";e.allLocations().forEach(function(i){var n=i.name().toLowerCase();-1==n.indexOf(o)?(i.show(!1),i.marker.setMap(null)):(i.show(!0),i.marker.setMap(e.map))})}),e.drawMap()};