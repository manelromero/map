function startModel(){vm=new ViewModel,ko.applyBindings(vm)}function googleMapsError(){document.getElementsByClassName("map")[0].innerHTML='<div class="google-error">Sorry, Google Map could not be loaded</div>'}var LOC_SW=[41.365,2.123],LOC_NE=[41.414,2.221],Location=function(e,o,n){this.id=e.id,this.name=ko.observable(e.name),this.address=ko.observable(e.address),this.show=ko.observable(!0),this.icon=ko.observable(e.icon),this.position=ko.observable(e.position),this.marker=o,this.infoWindow=n};Location.prototype.bounce=function(){var e;e=this.hasOwnProperty("marker")?this.marker:this,e.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){e.setAnimation(null)},750)},Location.prototype.extraInfo=function(){var e=document.getElementsByClassName("modal")[0];window.onclick=function(o){o.target==modal&&(e.style.display="none")},document.getElementsByClassName("flickr-pictures")[0].innerHTML="",document.getElementsByClassName("wiki-content")[0].innerHTML="",e.style.display="block",document.getElementsByClassName("close")[0].addEventListener("click",function(){e.style.display="none"});var o,n="https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=dc610307d5d7e99c3a682062435787d5";$.getJSON(n,{text:this.name,per_page:5,format:"json",nojsoncallback:1}).done(function(e){e.photos.photo.length>0?$.each(e.photos.photo,function(e,n){o="http://farm"+n.farm+".static.flickr.com/"+n.server+"/"+n.id+"_"+n.secret+".jpg",vm.flickrPictures.push({pictureUrl:o})}):document.getElementsByClassName("flickr-pictures")[0].innerHTML="<div>Sorry, Flickr images could not be loaded</div>"}).fail(function(e){document.getElementsByClassName("flickr-images")[0].innerHTML="<div>Sorry, Flickr images could not be loaded</div>"}),this.infoWindow.close(),$.ajax({url:"https://en.wikipedia.org/w/api.php?action=opensearch&search="+this.name(),dataType:"jsonp",headers:{"Api-User-Agent":"Example/1.0"}}).done(function(e){var o=e[1];if(o.length>0)for(var n=0;n<o.length;n++){var i=o[n],t="http://en.wikipedia.org/wiki/"+i;vm.wikiLinks.push({linkName:i,wikiLink:t})}else document.getElementsByClassName("wiki-content")[0].innerHTML="Sorry, no links from Wikipedia for this location"}).fail(function(e){document.getElementsByClassName("wiki-content")[0].innerHTML="Sorry, Wikipedia links could not be loaded"})};var ViewModel=function(){function e(){document.getElementsByClassName("map")[0].style.height=window.innerHeight-60+"px"}var o=this,n=document.getElementsByClassName("filter-field")[0],i=[];o.flickrPictures=ko.observableArray([]),o.wikiLinks=ko.observableArray([]),o.filterText=ko.observable(),o.allLocations=ko.observableArray([]),o.map=new google.maps.Map(document.getElementsByClassName("map")[0]),localStorage.mapLocations=JSON.stringify(locations),i=JSON.parse(localStorage.mapLocations),window.onresize=function(){e()},o.drawMap=function(){e();var n=new google.maps.LatLng(LOC_SW[0],LOC_SW[1]),t=new google.maps.LatLng(LOC_NE[0],LOC_NE[1]),a=new google.maps.LatLngBounds(n,t),s=0;o.map.fitBounds(a),i.forEach(function(e){e.id=s;var n=new google.maps.Marker({position:e.position,map:o.map,icon:e.icon,title:e.name}),i='<div class="map-name">'+e.name+'</div><div class="map-address">'+e.address+'</div><div><a class="info-link">+info</a></div>',t=new google.maps.InfoWindow({content:i});o.allLocations.push(new Location(e,n,t)),s++,n.addListener("click",function(){for(var i=0;i<o.allLocations().length;i++)o.allLocations()[i].infoWindow.close();t.open(o.map,n);var a=document.getElementsByClassName("info-link")[0],s=function(){o.allLocations()[e.id].extraInfo(),a.removeEventListener("click",s,!1)};a.addEventListener("click",s,!1),o.allLocations()[e.id].bounce()})})},n.addEventListener("input",function(){o.filterText(o.value.toLowerCase())}),o.toggleInfo=function(e){google.maps.event.trigger(e.marker,"click")},o.filterLocations=ko.computed(function(){var e=o.filterText()||"";o.allLocations().forEach(function(n){var i=n.name().toLowerCase();-1==i.indexOf(e)?(n.show(!1),n.marker.setMap(null)):(n.show(!0),n.marker.setMap(o.map))})}),o.drawMap()};